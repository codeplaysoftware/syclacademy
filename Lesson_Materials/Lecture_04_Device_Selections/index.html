!<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../common-revealjs/css/reveal.css">
    <link rel="stylesheet" href="../common-revealjs/css/theme/white.css">
    <link rel="stylesheet" href="../common-revealjs/css/custom.css">
    <script>
      // This is needed when printing the slides to pdf
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
<      link.href = window.location.search.match( /print-pdf/gi ) ? '../common-revealjs/css/print/pdf.css' : '../common-revealjs/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
    <script>
      // This is used to display the static images on each slide,
      // See global-images in this html file and custom.css
      (function() {
	  if(window.addEventListener) {
	      window.addEventListener('load', () => {
		  let slides = document.getElementsByClassName("slide-background");
		  
		  if (slides.length === 0) {
		      slides = document.getElementsByClassName("pdf-page")
		  }
		  
		  // Insert global images on each slide
		  for(let i = 0, max = slides.length; i < max; i++) {
		      let cln = document.getElementById("global-images").cloneNode(true);
		      cln.removeAttribute("id");
		      slides[i].appendChild(cln);
		  }
		  
		  // Remove top level global images
		  let elem = document.getElementById("global-images");
		  elem.parentElement.removeChild(elem);
	      }, false);
	  }
      })();
    </script>
    <style>
      .container{
	  display: flex;
      }
      .col{
	  flex: 1;
      }
      .codesize1{
	  font-size: 14px;
      }
      .codesize2{
	  font-size: 21px;
      }
      .codesize3{
	  font-size: 28px;
      }
      .codesize4{
	  font-size: 35px;
      }
      .bulletsized1{
	  font-size: 50%;
      }
      .bulletsized2{
	  font-size: 70%;
      }
      .bulletsized3{
	  font-size: 85%;
      }
    </style>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
	<div id="global-images" class="global-images">
	  <img src="../common-revealjs/images/sycl_academy.png" />
	  <img src="../common-revealjs/images/sycl_logo.png" />
	  <img src="../common-revealjs/images/trademarks.png" />
	  <img src="../common-revealjs/images/sc23.png" />
	</div>
	<section>
		<div class="container" data-markdown>
			![SYCL](../common-revealjs/images/sc23-title.png "SYCL")
		</div>
	</section>
	<section data-markdown
		 data-separator="^---\n"
		 data-separator-vertical="^vvv\n"
		 data-separator-notes="^Speaker Notes:">
	  <textarea data-template>

<!-- Ideally, only the markdown below needs editting to change slides. Focus on content! -->

## Device Discovery
---
## Learning Objectives
<ul>
  <li> Learn about the SYCL system topology and how to traverse it
  <li> Learn how to query information about a platform or device
  <li> Learn how to select a device; both manually and using device selectors
</ul>
---
#### SYCL System Topology
* A SYCL application can execute work across a range of different heterogeneous devices.
* The devices that are available in any given system are determined at runtime through topology discovery.
---
#### Platforms and devices
<!-- Two column magic needs HTML in the markdown ; unfortunately as a side-effect some markdown stops working so we resort to HTML -->
<div class="container">
  <div class="col">
    <ul>
      <li> The SYCL runtime will discover a set of platforms that are available in the system.
	<ul>
	  <li> Each platform represents a backend implementation such as Intel OpenCL or Nvidia PTX.
	</ul>
      <li> The SYCL runtime will also discover all the devices available for each of those platforms.
	<ul>
	  <li> CPU, GPU, FPGA, and other kinds of accelerators.
	</ul>
    </ul>
  </div>
  <div class="col">
    <img src="../common-revealjs/images/devices-1.png" alt="SYCL-Devices">
  </div>
</div>

---
#### Platform and device classes

* Platforms and devices are represented by the platform and device classes respectively.
<img src="../common-revealjs/images/devices-1.png" alt="SYCL-Devices">
---
#### Querying the topology
<ul>
  <li> In SYCL there are two ways to query a systemâ€™s topology.
    <ul>
      <li> The topology can be manually queried and iterated over via APIs of the platform and device classes .
      <li> The topology can be automatically queried and iterated over using a use  specified heuristic by a device selector object.
    </ul>
</ul>
---
#### Querying manually

<pre><code class="codesize3" data-trim data-noescape data-line-numbers="">
    auto platforms = platform::get_platforms();
</code></pre>
<!-- Two column magic needs HTML in the markdown ; unfortunately as a side-effect some markdown stops working so we resort to HTML -->
<div class="container">

  <div class="col">
    <img src="../common-revealjs/images/devices-5.png" alt="SYCL-Devices">
  </div>

  <div class="col">
    <ul>
      <li> The platform class provides the static function get_platforms.
      <li> It retrieves a vector of all available platforms in the system.
    </ul>
  </div>
</div>
---
#### Querying manually

<pre><code class="codesize3" data-trim data-noescape data-line-numbers="">
    auto intelDevices = intelPlatform.get_devices();
</code></pre>

<!-- Two column magic needs HTML in the markdown ; unfortunately as a side-effect some markdown stops working so we resort to HTML -->
<div class="container">

  <div class="col">
    <img src="../common-revealjs/images/devices-6.png" alt="SYCL-Devices">
  </div>

  <div class="col">
    <ul>
      <li> The platform class provides the member function get_devices that returns a vector of all devices associated with that platform.
    </ul>
  </div>
</div>
---
#### Querying manually

<pre><code class="codesize3" data-trim data-noescape data-line-numbers="">
    auto devices = device::get_devices();
</code></pre>

<!-- Two column magic needs HTML in the markdown ; unfortunately as a side-effect some markdown stops working so we resort to HTML -->
<div class="container">
  <div class="col">
    <img src="../common-revealjs/images/devices-7.png" alt="SYCL-Devices">
  </div>
  <div class="col">
    <ul>
      <li> The device class also provides the static function get_devices that returns a vector of all available devices in the system.
    </ul>
  </div>
</div>
---
#### Querying with a device selector

<img src="../common-revealjs/images/topology-1.png" alt="Device-Topology">

<div class="bulletsized1">
  <ul>
    <li> To simplify the process of traversing the system topology SYCL provides device selectors.
    <li> A device selector is is a callable C++ object which defines a heuristic for scoring devices.
    <li> SYCL provides a number of standard device selectors, e.g. default_selector_v, gpu_selector_v, etc.
    <li> Users can also create their own device selectors.
  </ul>
</div>
---
#### Querying with a device selector

<pre><code class="codesize3" data-trim data-noescape data-line-numbers="">
    auto gpuDevice = device(gpu_selector_v); 
</code></pre>

<!-- Two column magic needs HTML in the markdown ; unfortunately as a side-effect some markdown stops working so we resort to HTML -->
<div class="container">

  <div class="col">
    <img src="../common-revealjs/images/topology-1.png" alt="Device-Topology">
  </div>
  <div class="col">
    <ul>
      <li> A device selector takes a parameter of type const device & and gives it a "score".
      <li> Used to query all devices and return the one with the highest "score".
      <li> A device with a negative score will never be chosen.
    </ul>
  </div>
</div>
---
#### Querying the topology using a device selector

<pre><code class="codesize3" data-trim data-noescape data-line-numbers="">
    auto chosenDevice = device();
    auto chosenDevice = device(default_selector_v);
</code></pre>
<!-- Two column magic needs HTML in the markdown ; unfortunately as a side-effect some markdown stops working so we resort to HTML -->
<div class="container">
  <div class="col">
    <img src="../common-revealjs/images/topology-1.png" alt="Device-Topology">
  </div>
  <div class="col">
    <ul>
      <li> The default_selector_v is a standard device selector.
      <li> Chooses a device based on an implementation defined heuristic.
      <li> A default constructed device or platform will use this selector.
    </ul>
  </div>
</div>
---
#### Creating a custom device selector

<pre><code class="codesize3" data-trim data-noescape data-line-numbers="">
<mark>int my_gpu_selector(const device& dev) {</mark>

<mark>}</mark>
</code></pre>

<ul>
  <li> A device selector can be any callable object.
  <li> A device selector must have a function call operator which takes a reference to a device.
</ul>
---
#### Creating a custom device selector

<pre><code class="codesize2" data-trim data-noescape data-line-numbers="">
int my_gpu_selector(const device& dev) {
  <mark>if (dev.is_gpu()){</mark>
    <mark>return 1;</mark>
  <mark>}</mark>
  <mark>else {</mark>
    <mark>return -1;</mark>
  <mark>}</mark>
}
</code></pre>

<ul>
  <li> The body of the function call operator defines the heuristic for selecting devices
  <li> This is where you write the logic for scoring each device
</ul>
---
#### Creating a custom device selector

<pre><code class="codesize1" data-trim data-noescape data-line-numbers="">
int my_gpu_selector(const device& dev) {
  if (dev.is_gpu()){
    return 1;
  }
  else {
    return -1;
  }
}

int main(int argc, char *argv[]) {
  <mark>auto gpuQueue = queue{my_gpu_selector};</mark>

}
</code></pre>

<ul>
  <li> Now that there is a device selector that chooses a specific device we can use that to construct a queue.
</ul>
---
#### Platform/device info

<pre><code class="codesize2" data-trim data-noescape data-line-numbers="">
auto plt = dev.get_platform();
auto platformName
  = dev.get_info&lt;&zwnj;info::device::name&gt;();
</code></pre>

<!-- Two column magic needs HTML in the markdown ; unfortunately as a side-effect some markdown stops working so we resort to HTML -->
<div class="container">
  <div class="col">
    <img src="../common-revealjs/images/topology-2.png" alt="SYCL-Devices">
  </div>
  <div class="col">
    <ul>
      <li> Information about platforms and devices can be queried using the template member function get_info.
      <li> The info that you are querying is specified by the template parameter.
      <li> You can also query a device for its associated platform with the get_platform member function.
    </ul>
  </div>
</div>
---
#### Aspects

<pre><code class="codesize3" data-trim data-noescape data-line-numbers="">
bool supportsFp16 = dev.has(aspect::fp16);
<code></pre>

<ul>
  <li> Capabilities of a device or platform are represented by aspects.
  <li> These can be queried via the <b>has</b> member function.
</ul>
---
## Questions?
---
#### Exercise

Lesson_Materials/Lecture_04_Device_Selections

Create your own device selector that chooses the device in your system that you would like to target.

<em>Hint: Look at Figure 12-4 in the book and the text that preceeds it.</em>


	  </textarea>
	</section>
      </div>
    </div>
    <script src="../common-revealjs/js/reveal.js"></script>
    <script src="../common-revealjs/plugin/markdown/marked.js"></script>
    <script src="../common-revealjs/plugin/markdown/markdown.js"></script>
    <script src="../common-revealjs/plugin/notes/notes.js"></script>
    <script>
      Reveal.initialize({mouseWheel: true, defaultNotes: true,margin:0.04});
      Reveal.configure({ slideNumber: true });
    </script>
  </body>
</html>


